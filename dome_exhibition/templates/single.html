<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Together We Glow</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/buttons.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/single.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modal.css') }}">
    <style>
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        @keyframes glow {
            0%, 100% {
                box-shadow: 0 0 5px currentColor;
            }
            50% {
                box-shadow: 0 0 20px currentColor, 0 0 30px currentColor;
            }
        }

        @keyframes shake {
            0%, 100% {
                transform: translateX(0);
            }
            10%, 30%, 50%, 70%, 90% {
                transform: translateX(-5px);
            }
            20%, 40%, 60%, 80% {
                transform: translateX(5px);
            }
        }

        @keyframes scoreUpdate {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
                color: #27ae60;
            }
            100% {
                transform: scale(1);
            }
        }

        @keyframes levelUp {
            0% {
                transform: scale(1) rotate(0deg);
            }
            50% {
                transform: scale(1.3) rotate(180deg);
            }
            100% {
                transform: scale(1) rotate(360deg);
            }
        }

        .game-container {
            animation: fadeInUp 0.8s ease-out;
        }

        .game-container > * {
            animation: fadeInUp 0.6s ease-out;
        }

        .game-container > *:nth-child(1) { animation-delay: 0.1s; }
        .game-container > *:nth-child(2) { animation-delay: 0.2s; }
        .game-container > *:nth-child(3) { animation-delay: 0.3s; }
        .game-container > *:nth-child(4) { animation-delay: 0.4s; }
        .game-container > *:nth-child(5) { animation-delay: 0.5s; }
        .game-container > *:nth-child(6) { animation-delay: 0.6s; }

        h1 {
            animation: pulse 3s ease-in-out infinite;
            text-shadow: 0 0 10px rgba(255, 110, 196, 0.5);
        }

        .stat-box {
            transition: all 0.3s ease;
        }

        .stat-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .stat-value {
            transition: all 0.3s ease;
        }

        .stat-value.updated {
            animation: scoreUpdate 0.6s ease-out;
        }

        .stat-value.level-up {
            animation: levelUp 1s ease-out;
        }

        .message-box {
            transition: all 0.3s ease;
            animation: fadeInUp 0.8s ease-out 0.7s both;
        }

        .message-box.game-over {
            animation: shake 0.5s ease-in-out;
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }

        .color-btn {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .color-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .color-btn:hover::before {
            left: 100%;
        }

        .color-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }

        .color-btn.active {
            animation: glow 0.3s ease-in-out;
        }

        .color-btn.correct {
            animation: pulse 0.5s ease-in-out;
        }

        .color-btn.wrong {
            animation: shake 0.5s ease-in-out;
        }

        .controls .btn {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .controls .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .controls .btn:hover::before {
            left: 100%;
        }

        .controls .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .user-info {
            animation: fadeInUp 0.8s ease-out 0.1s both;
        }

        #username-display {
            transition: all 0.3s ease;
        }

        #username-display:hover {
            transform: scale(1.05);
        }

        .modal-content {
            animation: fadeInUp 0.5s ease-out;
        }

        .modal-content h2 {
            animation: bounce 1s ease-in-out;
        }

        @media (max-width: 768px) {
            .color-btn:hover {
                transform: translateY(-2px) scale(1.02);
            }
            
            .stat-box:hover {
                transform: translateY(-3px);
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ff6ec4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-animation {
            animation: pulse 0.5s ease-in-out;
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }

        .error-animation {
            animation: shake 0.5s ease-in-out;
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="user-info">
            <div class="user-input-container">
                <input type="text" id="username-input" placeholder="input player name" maxlength="12">
                <button id="save-username-btn">save</button>
            </div>
            <div id="username-display">
                <span>player: </span>
                <span id="username-text">tourist</span>
            </div>
        </div>

        <h1>Together We Glow</h1>

        <div class="stats-container">
            <div class="stat-box">
                <div class="stat-label">level</div>
                <div id="level-value" class="stat-value">1</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">score</div>
                <div id="score-value" class="stat-value">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">length</div>
                <div id="sequence-length" class="stat-value">3</div>
            </div>
        </div>

        <div class="message-box" id="message-box">
            Click the 'Start Game' button to start the challenge!
        </div>

        <div class="game-board">
            <div class="color-btn" id="red-btn">
                <span class="btn-label">red</span>
            </div>
            <div class="color-btn" id="blue-btn">
                <span class="btn-label">blue</span>
            </div>
            <div class="color-btn" id="green-btn">
                <span class="btn-label">green</span>
            </div>
            <div class="color-btn" id="yellow-btn">
                <span class="btn-label">yellow</span>
            </div>
        </div>

        <div class="controls">
            <button id="start-btn" class="btn">start</button>
            <button id="reset-btn" class="btn">reset</button>
            <button id="back-btn" class="btn">back</button>
        </div>

        <div id="game-over-modal" class="modal-overlay">
            <div class="modal-content">
                <h2>game over</h2>
                <p><strong>player:</strong> <span id="modal-username">tourist</span></p>
                <p><strong>score:</strong> <span id="modal-score">0</span></p>
                <p id="modal-message" style="font-style: italic; color: #7f8c8d;"></p>
                <div>
                    <button id="play-again-btn">Play Again</button>
                    <button id="return-home-btn">Return to Home</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const socket = io(); 
        sessionStorage.setItem('has_played', 'true');


        const encouragementMessages = [
            "That is great! You have made a lot of progress!",
            "Try again, you will definitely break through yourself!",
            "Every failure is a step towards success!",
            "Keep up the good work, victory is ahead!",
            "Perseverance prevails!"
        ];

        const playerNameFromServer = "{{ player_name }}";
        const gameModeFromServer = "{{ game_mode }}";

        if (playerNameFromServer) {
            document.getElementById('username-text').textContent = playerNameFromServer;
            document.getElementById('username-display').style.display = 'flex';
            document.querySelector('.user-input-container').style.display = 'none';
        }

        const gameState = {
            level: 1,
            score: 0,
            targetSequence: [],
            playerSequence: [],
            isPlaying: false,
            waitingForInput: false
        };

        // -------------------------- WebSocket 事件监听 -----------------------------

        socket.on('connect', () => {
            console.log("socket[connect]receive::Connected with sid", socket.id);
            // console.log("Connected with sid:", socket.id);
            // 将 sid 发送到后端绑定 username
            //socket.emit('register_user', { username: currentUsername, sid: socket.id });
            //joinRoom(); 
        });

        socket.on('disconnect', () => {
            console.log("socket[disconnect]receive:Disconnected from server");
        });

        socket.on('join_denied', (data) => {
            alert(data.message || "Unable to join room");
            setTimeout(() => {
                window.location.href = '/mode_selection';
            }, 200);
        });

        // DOM element
        const levelValue = document.getElementById('level-value');
        const scoreValue = document.getElementById('score-value');
        const sequenceLength = document.getElementById('sequence-length');
        const messageBox = document.getElementById('message-box');
        const startBtn = document.getElementById('start-btn');
        const resetBtn = document.getElementById('reset-btn');
        const backBtn = document.getElementById('back-btn');
        const colorButtons = {
            red: document.getElementById('red-btn'),
            blue: document.getElementById('blue-btn'),
            green: document.getElementById('green-btn'),
            yellow: document.getElementById('yellow-btn')
        };

        function initGame() {
            gameState.level = 1;
            gameState.score = 0;
            gameState.targetSequence = [];
            gameState.playerSequence = [];
            gameState.isPlaying = false;
            gameState.waitingForInput = false;

            updateUI();
            // The sequence-display div is commented out in HTML, so no need to clear it.
            // clearSequenceDisplay();
            messageBox.textContent = "Click the 'start' button to start the challenge!";
            messageBox.classList.remove('game-over');
        }

        function updateUI() {
            levelValue.textContent = gameState.level;
            scoreValue.textContent = gameState.score;
            sequenceLength.textContent = gameState.targetSequence.length;

            Object.values(colorButtons).forEach(btn => {
                btn.classList.toggle('disabled', !gameState.waitingForInput);
            });
        }

        function highlightButton(color) {
            const btn = colorButtons[color];
            if (!btn) return;

            btn.classList.add('active');
            setTimeout(() => {
                btn.classList.remove('active');
            }, 300);
        }

        startBtn.addEventListener('click', async () => {
            if (gameState.isPlaying) return;

            try {
                messageBox.textContent = `Observe the light!`;
                const response = await fetch('/api/game/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        playerName: 'Player1'
                    })
                });

                const data = await response.json();

                if (data.status === 'started') {
                    gameState.isPlaying = true;
                    gameState.level = data.level;
                    gameState.targetSequence = data.sequence;

                    new Promise((resolve) => {
                        const checkForReadyInput = (data) => {
                            if (data.status === 'ready_for_input') {
                                socket.off('game_update');
                                resolve();
                            }
                        };

                        socket.on('game_update', checkForReadyInput);
                    }).then(() => {
                        console.log('1树莓派已完成序列显示,请玩家开始输入');
                        gameState.waitingForInput = true;
                        updateUI();
                        messageBox.textContent = `A sequence of ${gameState.targetSequence.length} colors will play — repeat it!`;
                        
                    });
                }
            } catch (error) {
                console.error('Error!', error);
                messageBox.textContent = "Game start failed,please try again later.";
            }
        });

        Object.entries(colorButtons).forEach(([color, btn]) => {
            btn.addEventListener('click', () => {
                if (!gameState.waitingForInput || !gameState.isPlaying) return;

                highlightButton(color);
                gameState.playerSequence.push(color);

                if (gameState.playerSequence.length === gameState.targetSequence.length) {
                    checkPlayerSequence();
                }
            });
        });

        async function checkPlayerSequence() {
            gameState.waitingForInput = false;
            updateUI();

            try {
                const response = await fetch('/api/game/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        level: gameState.level,
                        playerSequence: gameState.playerSequence,
                        targetSequence: gameState.targetSequence
                    })
                });

                const result = await response.json();

                if (result.result === 'correct') {
                     if (gameState.level >= 10) {
                        gameState.isPlaying = false;
                        messageBox.textContent = `Congradulation! Your score is:${gameState.score}`;
                        showGameOverModal(gameState.score); 
                        return;
                    }

                    gameState.score = result.score;
                    gameState.level = result.nextLevel;
                    gameState.playerSequence = [];

                    messageBox.textContent = `Next turn! Observe the light!`;

                    setTimeout(async () => {
                        const seqResponse = await fetch(`/api/game/sequence?level=${gameState.level}`);
                        const seqData = await seqResponse.json();

                        gameState.targetSequence = seqData.sequence;
                        // messageBox.textContent = `第${gameState.level}关准备中...`;
                        new Promise((resolve) => {
                            const checkForReadyInput = (data) => {
                                if (data.status === 'ready_for_input') {
                                    socket.off('game_update'); 
                                    resolve();
                                }
                            };

                            socket.on('game_update', checkForReadyInput);
                        }).then(() => {
                            console.log('2树莓派已完成序列显示,请玩家开始输入');
                            gameState.waitingForInput = true;
                            updateUI();
                            messageBox.textContent = `A sequence of ${gameState.targetSequence.length} colors will play — repeat it!`;
                        });
                    }, 500);

                } else {
                    gameState.isPlaying = false;
                    messageBox.textContent = `Game Over! Your Score: ${gameState.score} Reached level: ${gameState.level}`;
                    messageBox.classList.add('game-over');
                    showGameOverModal(gameState.score); 
                }

                updateUI();
            } catch (error) {
                console.error('验证序列失败:', error);
                messageBox.textContent = "Verification failed, please try again!";
            }
        }

        resetBtn.addEventListener('click', () => {
            fetch('/api/game/reset', { method: 'POST' })
                .then(() => initGame())
                .catch(error => {
                    console.error('重置游戏失败:', error);
                    messageBox.textContent = "Reset failed, please try again!";
                });
        });

        backBtn.addEventListener('click', () => {
            window.location.href = '/';
        });

        initGame();

        function showGameOverModal(finalScore) {
            const modal = document.getElementById('game-over-modal');
            const usernameDisplay = document.getElementById('modal-username');
            const scoreDisplay = document.getElementById('modal-score');
            const messageDisplay = document.getElementById('modal-message');

            usernameDisplay.textContent = playerNameFromServer || 'tourist';
            scoreDisplay.textContent = finalScore;

            const randomMsg = encouragementMessages[
                Math.floor(Math.random() * encouragementMessages.length)
            ];
            messageDisplay.textContent = randomMsg;

            modal.style.display = 'flex';

            document.getElementById('play-again-btn').onclick = () => {
                modal.style.display = 'none';
                initGame();
                // If you want to automatically start a new game after "Play Again", uncomment the line below.
                // start_game();
            };

            document.getElementById('return-home-btn').onclick = () => {
                window.location.href = '/mode_selection';
            };
        }
    </script>
</body>
</html>